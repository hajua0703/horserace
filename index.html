<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>ì‚°ì†¦'s ê²½ë§ˆ ê²Œì„</title>
    <link rel="stylesheet" href="style.css"> 
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <h1>ğŸ ë§ë‹¬ë¦¬ì ğŸ</h1>

    <div id="main-container">
        <div id="track-area">
            <div class="finish-line"></div>
            </div>

        <div id="scoreboard">
            <h3>ğŸ† ê²½ê¸° ê¸°ë¡ ğŸ†</h3>
            <ul id="history-list">
                <li>ë°ì´í„° ë¡œë”© ì¤‘...</li>
            </ul>
        </div>
    </div>

    <button id="start-btn">ê²½ë§ˆ ì‹œì‘!</button>

    <script>
        // 1. Supabase ì„¤ì •
        const SUPABASE_URL = 'https://zwgznwoywgvlyujbmdwx.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3Z3pud295d2d2bHl1amJtZHd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NTEyNTMsImV4cCI6MjA4MTUyNzI1M30.m_7wSDQZLNFgJzY5Xq4HcJbCJmRyp9D4s4wTWtNp0Mc';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const trackArea = document.getElementById('track-area');
        const startBtn = document.getElementById('start-btn');
        const historyList = document.getElementById('history-list');
        const horseCount = 10;
        let isRacing = false;

       for (let i = 1; i <= horseCount; i++) {
    const lane = document.createElement('div');
    lane.className = 'lane';
    
    // ì´ë¯¸ì§€ì™€ ë²ˆí˜¸ë¥¼ horse-boxë¼ëŠ” ê·¸ë£¹ìœ¼ë¡œ ë¬¶ì—ˆìŠµë‹ˆë‹¤.
    lane.innerHTML = `
        <div class="horse" id="horse${i}" style="left: 0px;">
            <div class="horse-container">
                <span class="horse-number">${i}</span>
                <img src="ë§${i}.png" class="horse-img">
            </div>
        </div>`;
    
    trackArea.appendChild(lane);
}

        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        loadHistory();

        // [ê¸°ëŠ¥ 1] ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadHistory() {
            const { data, error } = await _supabase
                .from('race_results')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                historyList.innerHTML = '<li>ì—°ê²° ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.</li>';
                return;
            }

            historyList.innerHTML = '';
            data.forEach((row, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${data.length - index}R</strong>: ${row.ranks}`;
                historyList.appendChild(li);
            });
        }

        // [ê¸°ëŠ¥ 2] ê²½ê¸° ì‹œì‘
        startBtn.onclick = () => {
    if (isRacing) return;
    isRacing = true;
    startBtn.disabled = true;

    const horses = document.querySelectorAll('.horse');
    const trackWidth = trackArea.clientWidth - 100; 
    let finishedHorses = [];

    // ìœ„ì¹˜ ì´ˆê¸°í™”
    horses.forEach((h) => {
        h.style.left = '0px';
    });

    const timer = setInterval(() => {
        horses.forEach(horse => {
            let currentPos = parseFloat(horse.style.left);
            
            if (currentPos < trackWidth) {
                let progress = currentPos / trackWidth; // ê²½ì£¼ ì§„í–‰ë¥  (0 ~ 1)
                let move = 0;

                if (progress < 0.6) {
                    // [ì „ë°˜ë¶€] ê°„ê²©ì„ ë„“íˆê¸° ìœ„í•´ ìš´ì˜ ë²”ìœ„ë¥¼ í¬ê²Œ ì„¤ì • (0px ~ 12px)
                    // ì–´ë–¤ ë§ì€ ì•„ì˜ˆ ë©ˆì¶° ìˆê³ , ì–´ë–¤ ë§ì€ ì‘¥ì‘¥ ë‚˜ê°‘ë‹ˆë‹¤.
                    move = Math.random() * 12; 
                } else {
                    // [í›„ë°˜ë¶€] 60% ì§€ì  í†µê³¼ í›„ ì—­ì „ ë¡œì§
                    // ë’¤ì²˜ì§„ ë§ì¼ìˆ˜ë¡ ë” ë†’ì€ í™•ë¥ ë¡œ 'ìŠˆí¼ ë¶€ìŠ¤íŠ¸' ë°œìƒ
                    let rankBonus = (trackWidth - currentPos) / trackWidth * 10; // ë’¤ì— ìˆì„ìˆ˜ë¡ ë³´ë„ˆìŠ¤ ì¦ê°€
                    let isSpurt = Math.random() > 0.8; // 20% í™•ë¥ ë¡œ ìŠ¤í¼íŠ¸
                    
                    move = (Math.random() * 5) + (isSpurt ? 15 + rankBonus : 0);
                }
                
                let newPos = currentPos + move;
                // í”¼ë‹ˆì‹œ ë¼ì¸ì„ ë„˜ì§€ ì•Šê²Œ ë³´ì •
                if (newPos > trackWidth) newPos = trackWidth;
                
                horse.style.left = newPos + 'px';

                // ê³¨ì¸ íŒì •
                const horseId = horse.id.replace('horse', '');
                if (newPos >= trackWidth && !finishedHorses.includes(horseId)) {
                    finishedHorses.push(horseId);
                }
            }
        });

        if (finishedHorses.length === 10) {
            clearInterval(timer);
            saveResult(finishedHorses); // Supabase ì €ì¥ í•¨ìˆ˜ í˜¸ì¶œ
            isRacing = false;
            startBtn.disabled = false;
        }
    }, 50); 
};

        // [ê¸°ëŠ¥ 3] ê²°ê³¼ ì €ì¥
        async function saveResult(ranks) {
            const rankString = ranks.join(' > ');
            
            // í˜„ì¬ ëª‡ ë¼ìš´ë“œì¸ì§€ ê³„ì‚° (ê¸°ë¡ ê°œìˆ˜ + 1)
            const { count } = await _supabase.from('race_results').select('*', { count: 'exact', head: true });
            
            const { error } = await _supabase
                .from('race_results')
                .insert([{ round: (count || 0) + 1, ranks: rankString }]);

            if (error) console.error('ì €ì¥ ì‹¤íŒ¨:', error);
            
            await loadHistory();
            isRacing = false;
            startBtn.disabled = false;
            alert("ê²½ê¸° ì¢…ë£Œ! ê²°ê³¼ê°€ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    </script>
</body>
</html>
