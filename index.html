<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>tì‚°ì†¦'s ê²½ë§ˆ ê²Œì„</title>
    <link rel="stylesheet" href="style.css"> 
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <h1>ğŸ ì‚°ì†¦'s ê²½ë§ˆ ê²Œì„ ğŸ</h1>

    <div id="main-container">
        <div id="track-area">
            <div class="finish-line"></div>
            </div>

        <div id="scoreboard">
            <h3>ğŸ† ê²½ê¸° ê¸°ë¡ ğŸ†</h3>
            <ul id="history-list">
                <li>ë°ì´í„° ë¡œë”© ì¤‘...</li>
            </ul>
        </div>
    </div>

    <button id="start-btn">ê²½ë§ˆ ì‹œì‘!</button>

    <script>
        // 1. Supabase ì„¤ì •
        const SUPABASE_URL = 'https://zwgznwoywgvlyujbmdwx.supabase.co';
        const SUPABASE_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inp3Z3pud295d2d2bHl1amJtZHd4Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjU5NTEyNTMsImV4cCI6MjA4MTUyNzI1M30.m_7wSDQZLNFgJzY5Xq4HcJbCJmRyp9D4s4wTWtNp0Mc';
        const _supabase = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

        const trackArea = document.getElementById('track-area');
        const startBtn = document.getElementById('start-btn');
        const historyList = document.getElementById('history-list');
        const horseCount = 10;
        let isRacing = false;

        // ë§ ìƒì„±
        for (let i = 1; i <= horseCount; i++) {
            const lane = document.createElement('div');
            lane.className = 'lane';
            lane.innerHTML = `<div class="horse" id="horse${i}" style="left: 0px;">ğŸ<sup>${i}</sup></div>`;
            trackArea.appendChild(lane);
        }

        // ì´ˆê¸° ë°ì´í„° ë¡œë“œ
        loadHistory();

        // [ê¸°ëŠ¥ 1] ê¸°ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
        async function loadHistory() {
            const { data, error } = await _supabase
                .from('race_results')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                historyList.innerHTML = '<li>ì—°ê²° ì„¤ì •ì„ í™•ì¸í•˜ì„¸ìš”.</li>';
                return;
            }

            historyList.innerHTML = '';
            data.forEach((row, index) => {
                const li = document.createElement('li');
                li.innerHTML = `<strong>${data.length - index}R</strong>: ${row.ranks}`;
                historyList.appendChild(li);
            });
        }

        // [ê¸°ëŠ¥ 2] ê²½ê¸° ì‹œì‘
        startBtn.onclick = () => {
            if (isRacing) return;
            isRacing = true;
            startBtn.disabled = true;

            const horses = document.querySelectorAll('.horse');
            // 1. íŠ¸ë™ ê¸¸ì´ë¥¼ ë” ê¸¸ê²Œ ëŠê»´ì§€ë„ë¡ ì„¤ì • (CSSì—ì„œ íŠ¸ë™ ë„ˆë¹„ë¥¼ 100%ë¡œ í•˜ê³  ë ì§€ì ì„ í¼ì§í•˜ê²Œ ì¡ìŒ)
            const trackWidth = trackArea.clientWidth - 80; 
            let finishedHorses = [];
            
            // ì´ˆê¸°í™”
            horses.forEach(h => h.style.left = '0px');

            // 2. 30ì´ˆ ë‚´ì™¸ë¡œ ë§ì¶”ê¸° ìœ„í•œ ë¡œì§ (ëœë¤ ê°€ì†ë„ ì¶”ê°€)
            const timer = setInterval(() => {
                horses.forEach(horse => {
                    let currentPos = parseFloat(horse.style.left);
                    
                    if (currentPos < trackWidth) {
                        // 3. í¥ë¯¸ì§„ì§„í•œ ëœë¤ ì´ë™: 0~1.5px ì‚¬ì´ë¡œ ì´ë™ (ì•„ì£¼ ì¡°ê¸ˆì”© ì´ë™í•˜ì—¬ ì˜¤ë˜ ê±¸ë¦¬ê²Œ í•¨)
                        // ì¤‘ê°„ì— ê°‘ìê¸° ë¹¨ë¦¬ ê°€ëŠ” 'ìŠ¤í¼íŠ¸' í™•ë¥  ì¶”ê°€
                        let boost = Math.random() > 0.95 ? 2.5 : 0; // 5% í™•ë¥ ë¡œ ìŠ¤í¼íŠ¸
                        let move = (Math.random() * 1.2) + boost; 
                        
                        let newPos = currentPos + move;
                        horse.style.left = newPos + 'px';

                        // ê³¨ì¸ ì§€ì  í™•ì¸
                        if (newPos >= trackWidth && !finishedHorses.includes(horse.id.replace('horse', ''))) {
                            finishedHorses.push(horse.id.replace('horse', ''));
                        }
                    }
                });

                if (finishedHorses.length === horseCount) {
                    clearInterval(timer);
                    saveResult(finishedHorses);
                }
            }, 50); // 0.05ì´ˆë§ˆë‹¤ ì‹¤í–‰
        };

        // [ê¸°ëŠ¥ 3] ê²°ê³¼ ì €ì¥
        async function saveResult(ranks) {
            const rankString = ranks.join(' > ');
            
            // í˜„ì¬ ëª‡ ë¼ìš´ë“œì¸ì§€ ê³„ì‚° (ê¸°ë¡ ê°œìˆ˜ + 1)
            const { count } = await _supabase.from('race_results').select('*', { count: 'exact', head: true });
            
            const { error } = await _supabase
                .from('race_results')
                .insert([{ round: (count || 0) + 1, ranks: rankString }]);

            if (error) console.error('ì €ì¥ ì‹¤íŒ¨:', error);
            
            await loadHistory();
            isRacing = false;
            startBtn.disabled = false;
            alert("ê²½ê¸° ì¢…ë£Œ! ê²°ê³¼ê°€ ê¸°ë¡ë˜ì—ˆìŠµë‹ˆë‹¤.");
        }
    </script>
</body>
</html>